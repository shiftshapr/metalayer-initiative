<!DOCTYPE html>
<html>
<head>
  <title>Presence</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="sidepanel.css">
  <!-- Load LOCAL Supabase JS Library -->
  <script src="lib/supabase.min.js"></script>
  <!-- Load Loosely Coupled Auth Manager -->
  <script src="auth-manager.js"></script>
</head>
<body>
  <!-- Main Sidebar Container -->
  <div class="sidebar-container">
    <!-- Header with logo and actions -->
    <header class="sidebar-header-main">
      <button id="close-sidebar-btn">&times;</button>
      <div class="logo-container">
        <div class="hexagon-logo">P</div>
        <span class="logo-text">resence</span>
        <span class="logo-beta">BETA</span>
        <span id="community-options-btn" class="dropdown-arrow">▼</span>
      </div>
      <div class="header-actions">
        <!-- Auth buttons removed - auth will be triggered on-demand -->
        <div id="user-info" style="display: none; margin-left: 10px; display: flex; align-items: center; gap: 5px; position: relative;">
          <img id="user-avatar" src="" alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%; cursor: pointer;">
          <div id="user-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; min-width: 120px;">
            <div style="padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 0.9em; color: #666;">Signed in as</div>
            <div id="user-menu-name" style="padding: 4px 12px; font-weight: bold; font-size: 0.9em;"></div>
            <div style="padding: 4px 0; border-top: 1px solid #eee;">
              <button id="logout-btn" style="width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9em;">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Community Dropdown Panel -->
    <div id="community-dropdown-panel" class="community-dropdown-panel" style="display: none;">
      <div class="community-item" data-community="main">
        <img src="/images/community1.png" alt="Community" class="community-icon-img">
        <div class="community-info">
          <div class="community-name">Main Community</div>
          <div class="community-tag">Primary</div>
        </div>
        <div class="community-checkmark active">✓</div>
        <div class="community-more">⋮</div>
      </div>
      <div class="community-item" data-community="other">
        <img src="/images/community2.png" alt="Community" class="community-icon-img">
        <div class="community-info">
          <div class="community-name">Other Community</div>
        </div>
        <div class="community-checkmark">✓</div>
        <div class="community-more">⋮</div>
      </div>
    </div>
    
    <!-- Main Navigation Tabs -->
    <div class="sidebar-nav-main">
      <button class="main-nav-tab active" data-tab="canopi-tab">Canopi</button>
      <button class="main-nav-tab" data-tab="rooms-tab">Rooms</button>
      <button class="main-nav-tab" data-tab="people-tab">People</button>
      <button class="main-nav-tab" data-tab="agent-tab">Agent</button>
      <button class="main-nav-tab discord-nav-tab" id="discord-btn" title="Join Discord">
        <svg class="discord-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
        </svg>
      </button>
    </div>
    
    <!-- Main Tab Contents -->
    <div class="sidebar-content">
      <!-- Canopi Tab Content -->
      <div id="canopi-tab" class="main-tab-content active">
        <div class="sidebar-nav-sub">
          <button class="sub-nav-tab active" data-subtab="canopi-live-chat">Live Chat</button>
          <button class="sub-nav-tab" data-subtab="canopi-visible">Visible</button>
        </div>
        <div id="canopi-live-chat" class="sub-tab-content active">
          <div class="canopi-placeholder">
            <h3>Canopi</h3>
            <p>Canopi functionality will be implemented here.</p>
          </div>
        </div>
        <div id="canopi-visible" class="sub-tab-content">
          <div class="canopi-placeholder">
            <h3>Visible</h3>
            <p>Visibility settings will be implemented here.</p>
          </div>
        </div>
      </div>
      
      <!-- Rooms Tab Content -->
      <div id="rooms-tab" class="main-tab-content">
        <h3>Rooms</h3>
        <p>Room list or content goes here.</p>
      </div>
      
      <!-- People Tab Content -->
      <div id="people-tab" class="main-tab-content">
        <!-- Search and Filter Bar -->
        <div class="people-search-bar">
          <div class="search-input-container">
            <input type="text" id="people-search" placeholder="Search people..." class="people-search-input">
            <button class="people-filter-btn" id="people-filter-btn">☰</button>
          </div>
        </div>
        
        <!-- Sub-navigation for People -->
        <div class="people-nav">
          <button class="people-nav-btn active" data-people-tab="friends">Friends</button>
          <button class="people-nav-btn" data-people-tab="requests">Friend Requests</button>
          <button class="people-nav-btn" data-people-tab="blocked">Blocked</button>
        </div>
        
        <!-- Friends Tab -->
        <div id="people-friends" class="people-tab-content active">
          <div class="people-list" id="friends-list">
            <!-- Friends will be loaded here -->
          </div>
        </div>
        
        <!-- Friend Requests Tab -->
        <div id="people-requests" class="people-tab-content">
          <div class="people-list" id="requests-list">
            <!-- Friend requests will be loaded here -->
          </div>
        </div>
        
        <!-- Blocked Users Tab -->
        <div id="people-blocked" class="people-tab-content">
          <div class="people-list" id="blocked-list">
            <!-- Blocked users will be loaded here -->
          </div>
        </div>
      </div>
      
      <!-- Agent Tab Content -->
      <div id="agent-tab" class="main-tab-content">
        <div class="agent-header">
          <h3>AI Agent</h3>
          <div class="agent-actions">
            <button id="agent-clear-btn">Clear</button>
            <button id="agent-refresh-btn">Refresh</button>
          </div>
        </div>
        <div class="agent-input-area">
          <input type="text" placeholder="Ask the agent something..." id="agent-input">
          <button id="agent-send-btn">✈</button>
        </div>
        <div class="agent-output" id="agent-output">
          <!-- Agent responses will appear here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mini Profile Modal -->
  <div id="mini-profile-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-name">User Name</h3>
        <button class="close-button">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modal-status">Status</div>
        <div class="modal-actions">
          <button class="action-button">Message</button>
          <button class="action-button">View Profile</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Debug Functions - REMOVED INLINE SCRIPT -->
  <!-- The debug logic is now in sidepanel.js -->
  
  <!-- Include the main sidebar JavaScript -->
  <script src="sidepanel.js"></script>

  <!-- Debug panel - Hidden -->
  <div id="debug" style="display: none;">
    <div id="debug-header" style="padding: 5px; background: #ddd; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 10px;">
      <span>Debug messages will appear here</span>
      <span id="debug-toggle" style="font-size: 12px;">▼</span>
    </div>
    <div id="debug-content" style="padding: 5px; font-size: 10px; max-height: 100px; overflow-y: auto; display: none;"></div>
  </div>

  <!-- Magic Link Modal -->
  <div id="magic-link-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Sign in with Magic Link</h3>
        <button id="close-magic-link-modal" class="close-button">&times;</button>
      </div>
      <div class="modal-body">
        <p>Enter your email address and we'll send you a magic link to sign in.</p>
        <input type="email" id="magic-link-email" placeholder="your@email.com" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;">
        <button id="send-magic-link" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Send Magic Link</button>
        <div id="magic-link-status" style="margin-top: 10px; font-size: 0.9em;"></div>
      </div>
    </div>
  </div>

  <style>
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 300px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    
    /* Auth Prompt Modal Styles */
    .auth-prompt-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }
    
    .auth-button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    .auth-button.google {
      background-color: #4285f4;
      color: white;
    }
    
    .auth-button.google:hover {
      background-color: #3367d6;
    }
    
    .auth-button.magic {
      background-color: #6c757d;
      color: white;
    }
    
    .auth-button.magic:hover {
      background-color: #5a6268;
    }
    
    .cancel-button {
      background: none;
      border: 1px solid #ccc;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      color: #666;
    }
    
    .cancel-button:hover {
      background-color: #f8f9fa;
    }
    
    /* Add Friend Button Styles */
    .add-friend-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8em;
      margin-left: auto;
    }
    
    .add-friend-btn:hover {
      background-color: #218838;
    }
    
    .add-friend-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
  </style>
</body>
</html>